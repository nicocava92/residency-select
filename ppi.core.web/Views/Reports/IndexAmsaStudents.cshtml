@model PPI.Core.Web.Models.AmsaReports.ViewModel.ReportStudentDataListViewModel

@{
    ViewBag.Title = "Participants for reports";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}
<div class="main-box clearfix">
    <div class="main-box-body">
        <div class="row">
            <div class="col-lg-4 col-md-4 col-sm-12 col-xs-12">
                <h2>List of Amsa Report Participants</h2>
            </div>

            <div class="col-lg-6 col-md-6 col-lg-offset-2 col-md-offset-2 col-sm-12 col-xs-12">
                <br />    
                <strong>Event:</strong><br>
                @using (Html.BeginForm("GetParticipantsByEvent", "Reports"))
                {
                    @Html.AntiForgeryToken()
                    @Html.DropDownListFor(model => model.idSelectedEvent, Model.Events, new { @class = "form-control", @onChange = "this.form.submit();", @Id = "selectEvent" })
                    @Html.ValidationMessage("FilterByEvent")
                }
                <br />
            </div>
        </div>

        <div class="row">
            <div class="col-lg-2 col-lg-offset-6">
                <a href="@Url.Action("UploadAMSADataFeed","Reports", new { id = Model.idSelectedEvent})" class="btn btn-primary pull-right btn-block">
                    <i class="fa fa-upload fa-lg"></i> Upload Data Feed
                </a> 
            </div>
            <div class="col-lg-2">
                <a href="@Url.Action("CreateAmsaStudents","Reports")" class="btn btn-primary pull-right btn-block">
                    <i class="fa fa-plus-circle fa-lg"></i> Add Student Results
                </a> 
            </div>
            <div class="col-lg-2">
                <div class="btn btn-primary btn-block" id="genReport">
                    <i class="fa fa-book fa-lg"></i>  Generate Reports
                </div>
            </div>
        </div>
        <br />
        <div class="row error alert-danger">
            
        </div>
        <br>
        <div class="row">
            <div class="col-lg-offset-6 col-lg-6 ">
                <a>

                </a>

            </div>
        </div>

        <table class="table table-striped">
            <thead>
                <tr>
                    <th>
                        <div class="checkbox-nice">
                            <input id="checkbox-selectAll" name="checkbox" type="checkbox">
                            <label for="checkbox-selectAll"></label>
                        </div>
                    </th>
                    <th>
                        PersonId
                    </th>
                    <th>
                        FirstName
                    </th>
                    <th>
                        LastName
                    </th>
                    <th>
                        Registration Date
                    </th>
                    <th>
                        Completed Date
                    </th>
                    <th>

                    </th>
                </tr>
            </thead>
            <tbody>
                @foreach (var student in Model.LstStudentData)
                {
                    string checkboxId = "checkbox" + @student.Id; 
                    <tr>
                        <td>
                            <div class="checkbox-nice">
                                <input id="@checkboxId" class="selected-person" name="checkbox" type="checkbox" data-userId="@student.Id">
                                <label for="@checkboxId"></label>
                            </div>
                        </td>
                        <td>
                            @student.PersonId
                        </td>
                        <td>
                            @student.FirstName
                        </td>
                        <td>
                            @student.LastName
                        </td>
                        <td>
                            @student.RegistrationDate
                        </td>
                        <td>
                            @student.CompletionDate
                        </td>
                        <td>
                            <!-- Buttons for actions go here, selection box for each student will go here as well -->
                            @Html.ActionLink("Edit", "EditAmsaStudents", "Reports", new { student.Id },new { @class = "btn btn-default btn-sm btn60" })
                        </td>
                    </tr>
                }
            </tbody>
            

        </table>


        <div class="modal fade" id="modalMessage" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        <h4 class="modal-title" id="myModalLabel">Report generation in progress</h4>
                    </div>
                    <div class="modal-body">
                        Your reports are being generated, you will receive a download link via e-mail when the report generation is finished.
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <script type="text/javascript">
        $(document).ready(function () {
            $("#genReport").unbind("click");
            $("#genReport").on("click",generateReport);

            //Producing reports with checkboxes

            //On select of top checkbox select all other checkboxes
            $("#checkbox-selectAll").on("click", function () {
                if ($(this).is(":checked")) {
                    //If the checkbox to select all is checked select all
                    changeValuesOfCheckbox("checked");
                }
                else {
                    //If the checkbox to deselect all is checked deselect all
                    changeValuesOfCheckbox("unchecked");
                }
            })

        });

        //Change what values are checked and what values are not checked
        function changeValuesOfCheckbox(s) {
            $(".selected-person").each(function (index) {
                if (s == "checked") {
                    $(this).prop("checked",true);
                }
                if (s == "unchecked") {
                    $(this).prop("checked",false);
                }
            });
        }

    
        function generateReport() {
            //Get the ids of participants for whom the report will be generated
            $(".error").fadeOut();
            var participantsId = [];
            $(".selected-person").each(function (index) {
                if ($(this).is(":checked")) {
                    participantsId.push($(this).data("userid"));
                }
            });
            if(participantsId.length > 0){
                //Show modal with message about report being generated
                $("#modalMessage").modal('show');
                $.ajax({
                    contentType: "application/json; charset=utf-8",
                    type: "POST",
                    url: "../Reports/getPdfReports",
                    datatype: "json",
                    data: JSON.stringify({
                        lstParticipantIds : participantsId
                    }),
                    traditional: true,
                    success: function (data) {
                    
                    },
                    error: function (data) {
                        console.log("Error processing request " + data);
                    }
                });
            }
            else {
                $(".error").fadeIn();
                $(".error").html('<div class="col-lg-12">'+
                    '<br /><p>Please select a participant  to generate reports, reports can\'t be generated if no participants are selected.</p>' +
                    '<br /></div>');
            }
        }

        
        


    </script>

</div>
